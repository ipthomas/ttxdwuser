{{define "spa2t_tmplt"}}
{{$logofile := .EnvVars.LOGO_FILE}}
{{$user := .Query.User}}
{{$org := .Query.Org}}
{{$role := .Query.Role}}
{{$pwy := .Query.Pathway}}
{{$nhs := .Query.Nhs}}
{{$exp := .Query.Expression}}
{{$vers := .Query.Vers}}
{{$status := .Query.Status}}
{{$wse := .EnvVars.SERVER_URL}}
<!DOCTYPE html>
<html>
    {{template "spaheader2t_tmplt" .}}
    <body onload="updateSrcURL()">
        <div class="container-fluid">
            <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12 sidebar" id="sidebar" name="sidebar">
                <p style="text-align: center;color: rgba(28, 8, 35, 0.199);font-size:xx-large;">Menu</p>
                <ul id="creatorul" style="display: none;">
                    <div class="trigger">
                        <li onclick="showprogress()">
                            <a id="sidebarCreator" href="/spa/consumer/creator?user={{$user}}&org={{$org}}&role={{$role}}&pathway={{$pwy}}&nhs={{$nhs}}" target="iconsumer">Create Workflow</a>
                        </li>
                        <div class="popup">
                            Create a New Workflow
                        </div>
                    </div>
                </ul>
                <ul id="hasnhsidul" style="display: none;">
                    <div class="trigger">
                        <li onclick="showprogress()">
                            <a id="sidebarAllPDQ" href="/beta/spa/consumer/patient?user={{$user}}&org={{$org}}&role={{$role}}&nhs={{$nhs}}" target="iconsumer">Patient Details</a>
                        </li>
                        <div class="popup">
                            Patient Information
                        </div>
                    </div>
                </ul>
                <ul id="publisherul" style="display: none;">
                    <div class="trigger">
                        <li onclick="showprogress()">
                            <a id="sidebarPublisher" href="/beta/spa/publisher/document?act=publish&user={{$user}}&org={{$org}}&role={{$role}}&nhs={{$nhs}}&pathway={{$pwy}}"
                                target="iconsumer">Publish Content</a>
                        </li>
                        <div class="popup">
                            Publish Document
                        </div>
                    </div>
                </ul>
                <ul>
                    <div class="trigger">
                        <li onclick="showprogress()">
                            <a id="sidebarmySubs" href="/beta/spa/consumer/mysubs?user={{$user}}&org={{$org}}&role={{$role}}&email={{$user}}@{{$org}}.co.uk" target="iconsumer">My Subscriptions</a>
                        </li>
                        <div class="popup">
                            Manage Subscriptions
                        </div>
                    </div>
                </ul>
                <ul id="haspwyul" style="display: none;">
                    <div class="trigger">
                        <li onclick="showprogress()">
                            <a id="sidebarSubs" href="/beta/spa/consumer/newsub?user={{$user}}&org={{$org}}&role={{$role}}&email={{$user}}@{{$org}}.co.uk&pathway={{$pwy}}&nhs={{$nhs}}&expression={{$exp}}" target="iconsumer">New Subscription</a>
                        </li>
                        <div class="popup">
                            Subscribe to Events
                        </div>
                    </div>
                </ul>
                <ul>
                    <div class="trigger">
                        <li onclick="showprogress()">
                            <a id="sidebarCodemaps" href="/beta/spa/consumer/codemap?user={{$user}}&org={{$org}}&role={{$role}}" target="iconsumer">My Terminolgy</a>
                        </li>
                        <div class="popup">
                            Manage Terminology
                        </div>
                    </div>
                </ul>
                <ul class="list-unstyled components">
                    <div class="trigger">
                        <li onclick="showprogress()">
                            <a id="sidebarRegisterDef" href="/beta/spa/consumer/definition?act=Register Definition&user={{$user}}&org={{$org}}&role={{$role}}" target="iconsumer">Register Definition</a>
                        </li>
                        <div class="popup">
                            Register New Workflow Definition
                        </div>
                    </div>
                </ul>
                <ul class="list-unstyled components">
                    <div class="trigger">
                        <li onclick="showprogress()">
                            <a id="sidebarRegisterTmplt" href="/beta/spa/consumer/template?act=Register Template&user={{$user}}&org={{$org}}&role={{$role}}"
                                target="iconsumer">Register Template</a>
                        </li>
                        <div class="popup">
                            Register New HTML Template
                        </div>
                    </div>
                </ul>
                {{if eq $org "2tsolutions"}}
                <ul>
                    <div class="trigger">
                        <li>
                            <a id="sidebarRegisterDefinitions" href="#" onclick="initDefinitions()">Load Definitions</a>
                        </li>
                        <div class="popup">
                            Register Workflow Definitions from Local Folder
                        </div>
                    </div>
                </ul>
                <ul>
                    <div class="trigger">
                        <li>
                            <a id="sidebarRegisterTmplts" href="#" onclick="initTmplts()">Load Templates</a>
                        </li>
                        <div class="popup">
                            Register Templates from Local Folder
                        </div>
                    </div>
                </ul>
                {{end}}
                <ul>
                    <div class="trigger">
                        <li>
                            <a id="clearcache" href="#" onclick="clearCache()">Clear Cache</a>
                        </li>
                        <div class="popup">
                            Clear Template and User Terminology caches
                        </div>
                    </div>
                </ul>
            </div>
            <div class="col-lg-9 col-md-8 col-sm-6 col-xs-12 main-content">
                <div class="trigger">
                    <h5>
                    <div class="row center-row">
                        <img id="logo" src="" alt="logo" class="toggle-sidebar" onclick="toggleSidebar()">
                        <div class="popup">
                            Toggle Workflow Service Menu
                        </div>
                    </div>
                    </h5>
                </div>
                <div>
                    <form onchange="updateSrcURL()" id="my-form" name="my-form" target="iconsumer" src="" method="get">
                        <label for="pathway"> Workflow:</label>
                        <div class="trigger">
                            <select class="form-control" id="pathway" name="pathway" value="{{$pwy}}" onchange="checkInputs()">
                                <option value="">All</option>
                            </select>
                            <div class="popup">
                                Select Workflow
                            </div>
                        </div>
                        <label for="nhs">NHS ID:</label>
                        <div class="trigger">
                            <input class="form-control" id="nhs" name="nhs" value="" style="width: 90px;" value="{{$nhs}}" onchange="checkInputs()">
                            <div class="popup">
                                Enter NHS ID
                            </div>
                        </div>
                        <label for="expression"> Event Type:</label>
                        <div class="trigger">
                            <select class="form-control" id="expression" name="expression">
                                <option value="">No Workflow Selected</option>
                            </select>
                            <div class="popup">
                                Select Event Type
                            </div>
                        </div>
                        <label for="vers">Version:</label>
                        <div class="trigger">
                            <input class="form-control" id="vers" name="vers" value="-1" style="width: 20px;">
                            <div class="popup">
                                Enter Workflow Version or -1 for All versions
                            </div>
                        </div>
                        <label for="vers">Status:</label>
                        <div class="trigger">
                            <select class="form-control" id="status" name="status" onchange="checkInputs()">
                                <option value="">All</option>
                                <option value="OPEN">Open</option>
                                <option value="CLOSED">Closed</option>
                            </select>
                            <div class="popup">
                                Select Workflow Status
                            </div>
                        </div>
                        <input type="hidden" class="form-control" id="act" name="act" value="select">
                        <label for="user"> User:</label>
                        <input class="form-control" id="user" name="user" value="{{$user}}" style="width: 90px;">
                        <label for="org"> Org:</label>
                        <input class="form-control" id="org" name="org" value="{{$org}}" style="width: 90px;">
                        <label for="role"> Role:</label>
                        <input class="form-control" id="role" name="role" value="{{$role}}" style="width: 90px;">
                        <input type="hidden" class="form-control" id="email" name="email" value="{{$user}}@{{$org}}.co.uk">
                    </form>
                </div>
                <div class="loader"></div>
                <div class="row">
                    <iframe width="100%" height="900" frameborder="0" name="iconsumer" title="iconsumer"
                         id="iconsumer" src="/beta/spa/consumer/xdws?user={{$user}}&org={{$org}}&role={{$role}}&nhs={{$nhs}}&pathway={{$pwy}}&status={{$status}}" onload="hideLoader()">
                    </iframe>
                    <script>
                        function hideLoader() {
                            document.querySelector('.loader').style.display = 'none';
                            document.querySelector('iframe').style.display = 'block';
                        }
                    </script>
                    <script>
                        window.onload = function () {
                            var iframe = document.querySelector('iframe');
                            iframe.onload = hideLoader;
                        };
                    </script>
            </div>
        </div>
        <script>
            function initDefinitions() {
                showprogress();
                const userValue = document.getElementById('user').value;
                const orgValue = document.getElementById('org').value;
                const roleValue = document.getElementById('role').value;
                fetch('/beta/spa/consumer/definitions?user=' + userValue + '&org=' + orgValue + '&role=' + roleValue)
                    .then(() => {
                        hideLoader();
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
            }
        </script>
        <script>
            function initTmplts() {
                showprogress();
                const userValue = document.getElementById('user').value;
                const orgValue = document.getElementById('org').value;
                const roleValue = document.getElementById('role').value;              
                fetch('/beta/spa/consumer/templates?user=' + userValue + '&org=' + orgValue + '&role=' + roleValue)
                    .then(() => {
                        hideLoader();
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
            }
        </script>
        <script>
            function clearCache() {
                showprogress();
                fetch('/beta/spa/consumer/clearcache')
                    .then(() => {
                        hideLoader();
                        console.log('Cleared Service Cache')
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
            }
        </script>
        <script>
                function updateSrcURL() {
                    const userValue = document.getElementById('user').value;
                    const orgValue = document.getElementById('org').value;
                    const roleValue = document.getElementById('role').value;
                    const pwyValue = document.getElementById('pathway').value;
                    const nhsValue = document.getElementById('nhs').value;
                    const statusValue = document.getElementById('status').value;
                    const versValue = document.getElementById('vers').value;
                    const emailValue = document.getElementById('email').value;
                    const expressionValue = document.getElementById('expression').value;
                    const creatorUrl = `/beta/spa/consumer/creator?user=${userValue}&org=${orgValue}&role=${roleValue}&pathway=${pwyValue}&nhs=${nhsValue}`;
                    const xdwsURL = `/beta/spa/consumer/xdws?user=${userValue}&org=${orgValue}&role=${roleValue}&vers=${versValue}&pathway=${pwyValue}&nhs=${nhsValue}&status=${statusValue}`;
                    const codemapsUrl = `/beta/spa/consumer/codemap?user=${userValue}&org=${orgValue}&role=${roleValue}`;
                    const allpdqUrl = `/beta/spa/consumer/patient?user=${userValue}&org=${orgValue}&role=${roleValue}&nhs=${nhsValue}`;
                    const publisherUrl = `/beta/spa/consumer/upload?act=publish&user=${userValue}&org=${orgValue}&role=${roleValue}&pathway=${pwyValue}&nhs=${nhsValue}&expression=${expressionValue}&vers=${versValue}`;
                    const mysubsUrl = `/beta/spa/consumer/mysubs?topic=EMAIL&user=${userValue}&org=${orgValue}&role=${roleValue}&email=${emailValue}`;
                    const subsUrl = `/beta/spa/consumer/newsub?topic=EMAIL&user=${userValue}&org=${orgValue}&role=${roleValue}&email=${emailValue}&pathway=${pwyValue}&expression=${expressionValue}&nhs=${nhsValue}`;
                    console.log('setting URLS');
                    document.getElementById('my-form').Action = xdwsURL;
                    document.getElementById('iconsumer').src = xdwsURL;
                    console.log('Consumer',xdwsURL);
                    document.getElementById('sidebarCreator').href = creatorUrl;
                    console.log('Creator',creatorUrl);
                    document.getElementById('sidebarCodemaps').href = codemapsUrl;
                    console.log('Codemaps',codemapsUrl);
                    document.getElementById('sidebarAllPDQ').href = allpdqUrl; 
                    console.log('Patient',allpdqUrl);
                    document.getElementById('sidebarPublisher').href = publisherUrl;
                    console.log('Publisher', publisherUrl);
                    document.getElementById('sidebarmySubs').href = mysubsUrl;
                    console.log('Consumer Subs',mysubsUrl);
                    document.getElementById('sidebarSubs').href = subsUrl;
                    console.log('Publisher Subs',subsUrl);
                }
            </script>
            <script>
                function toggleSidebar() {
                    var sb = document.getElementById("sidebar");
                    sb.classList.toggle("open");
                }
            </script>
            <script>
                function checkInputs() {
                    showprogress();
                    updateSrcURL()
                    const input1 = document.getElementById("nhs").value;
                    const input2 = document.getElementById("pathway").value;
                    const input3 = document.getElementById("expression").value;
                    const input4 = document.getElementById('vers').value;
                    const publisherElement = document.getElementById("publisherul");
                    const creatorElement = document.getElementById("creatorul");
                    const haspwyElement = document.getElementById("haspwyul");
                    const hasnhsidElement = document.getElementById("hasnhsidul");
                    if (input1 && input2) {
                        creatorElement.style.display = "block";
                        publisherElement.style.display = "block"
                    } else {
                        creatorElement.style.display = "none";
                        publisherElement.style.display = "none"
                    }
                    if (input1) {
                        hasnhsidElement.style.display = "block";
                    } else {
                        hasnhsidElement.style.display = "none";
                    }
                    if (input2) {
                        updateExpressions();
                        haspwyElement.style.display = "block";
                    } else {                   
                        updateExpressions();
                        haspwyElement.style.display = "none";
                    }
                }
            </script>
            <script>
                function updateExpressions() {
                    const selectedPwy = document.getElementById("pathway").value;
                    var expressions = document.getElementById('expression');
                    var userValue = document.getElementById('user').value;
                    var orgValue = document.getElementById('org').value;
                    var roleValue = document.getElementById('role').value;
                    while (expressions.options.length > 0) {
                        expressions.remove(0);
                    }
                    var alloption = document.createElement('option');
                        alloption.text = "Select Event";
                        alloption.value = "";
                        expressions.add(alloption);
                    fetch('/beta/spa/consumer/expressions?user=' + userValue + '&org=' + orgValue + '&role=' + roleValue + '&pathway=' + selectedPwy)
                            .then(response => response.json())
                            .then(data => {
                                data.forEach(item => {
                                    var exoption = document.createElement('option');
                                    exoption.text = item.Text;
                                    exoption.value = item.Value;
                                    expressions.add(exoption);
                                });
                            })
                            .catch(error => console.error(error));
                }
            </script>
            <script>
                function showprogress() {
                    document.querySelector('.loader').style.display = 'block';
                    document.querySelector('iframe').style.display = 'none';
                }
            </script>
            <script>
                window.addEventListener('load', function () {
                    var userValue = document.getElementById('user').value;
                    var orgValue = document.getElementById('org').value;
                    var roleValue = document.getElementById('role').value;                   
                    fetch('/beta/spa/consumer/pathways?user=' + userValue + '&org=' + orgValue + '&role=' + roleValue)
                        .then(response => response.json())
                        .then(data => {
                            const select = document.getElementById('pathway');
                            data.forEach(item => {
                                const option = document.createElement('option');
                                option.text = item.Text;
                                option.value = item.Value;
                                select.add(option);
                            });
                        })
                        .catch(error => console.error(error));
                });
            </script>
            <script>
                console.log('fetching logo');
                fetch('beta/spa/consumer/static?name=event-logo.png')
                    .then(response => response.text())
                    .then(data => {
                        document.getElementById('logo').src = 'data:image/png;base64,' + data;
                    })
                    .catch(error => {
                        console.log('Error fetching image:', error);
                    });
            </script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"
                integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous">
                </script>
            <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"
                integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous">
                </script>
    </body>
    <style>
        body {
            font-family: sans-serif;
        }
        .sidebar {
            height: 100%;
            width: 200px;
            position: fixed;
            top: 0;
            left: -200px;
            background-color: #e8f3f7;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
            font-family: sans-serif;
        }

        #sidebar.open {
            left: 0;
            width: 200px;
        }

        .main-content {
            transition: 0.5s;
            margin-left: 0;
            padding: 10px;
            font-family: sans-serif;
        }

        #sidebar.open~.main-content {
            margin-left: 200px;
        }

        button.toggle-sidebar {
            cursor: pointer;
            z-index: 999;
        }

        .popup {
            position: absolute;
            display: none;
            background-color: #f1f1f1;
            padding: 10px;
            border: 1px solid #ccc;
            z-index: 1;
        }

        .trigger {
            position: relative;
            display: inline-block;
        }

        .trigger:hover .popup {
            display: block;
        }

        .loader {
            border: 16px solid #f3f3f3;
            /* Light grey border */
            border-top: 16px solid #3498db;
            /* Blue border */
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        
        .progress {
            border: 12px solid #f3f3f3;
            /* Light grey border */
            border-top: 12px solid #3498db;
            /* Blue border */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
            display: block;
            position: absolute;
            top: 15%;
            left: 100%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }

        /* Animation for the loading icon */
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</html>
{{end}}